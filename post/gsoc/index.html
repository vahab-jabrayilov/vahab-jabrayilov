<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: July 17, 2023 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><script src=/js/mathjax-config.js></script>
<link rel=stylesheet href=/css/vendor-bundle.min.047268c6dd09ad74ba54a0ba71837064.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script>
<link rel=stylesheet href=/css/wowchemy.042e26407c9e383d96a1f26d6787c686.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><meta name=author content="Vahab Jabrayilov"><meta name=description content="My GSOC final report"><link rel=alternate hreflang=en-us href=https://vjabrayilov.github.io/post/gsoc/><link rel=canonical href=https://vjabrayilov.github.io/post/gsoc/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hufdc9ffe2c12a5bb5ad2cfdfce17ddfaa_56068_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hufdc9ffe2c12a5bb5ad2cfdfce17ddfaa_56068_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@wowchemy"><meta property="twitter:creator" content="@wowchemy"><meta property="twitter:image" content="https://vjabrayilov.github.io/media/icon_hufdc9ffe2c12a5bb5ad2cfdfce17ddfaa_56068_512x512_fill_lanczos_center_3.png"><meta property="og:site_name" content="Vahab Jabrayilov"><meta property="og:url" content="https://vjabrayilov.github.io/post/gsoc/"><meta property="og:title" content="GSoC Final Submission Thanos | Vahab Jabrayilov"><meta property="og:description" content="My GSOC final report"><meta property="og:image" content="https://vjabrayilov.github.io/media/icon_hufdc9ffe2c12a5bb5ad2cfdfce17ddfaa_56068_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-09-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-08T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://vjabrayilov.github.io/post/gsoc/"},"headline":"GSoC Final Submission Thanos","datePublished":"2022-09-08T00:00:00Z","dateModified":"2022-09-08T00:00:00Z","author":{"@type":"Person","name":"Vahab Jabrayilov"},"publisher":{"@type":"Organization","name":"Vahab Jabrayilov","logo":{"@type":"ImageObject","url":"https://vjabrayilov.github.io/media/icon_hufdc9ffe2c12a5bb5ad2cfdfce17ddfaa_56068_192x192_fill_lanczos_center_3.png"}},"description":"My GSOC final report"}</script><title>GSoC Final Submission Thanos | Vahab Jabrayilov</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=9d27554a92ed23a2ac723c70ba653c4d><script src=/js/wowchemy-init.min.ec9d49ca50e4b80bdb08f0417a28ed84.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Vahab Jabrayilov</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Vahab Jabrayilov</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#experience><span>Experience</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class="nav-link active" href=/post><span>Posts</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/vjabrayilov7 data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>GSoC Final Submission Thanos</h1><div class=article-metadata><div><span class=author-highlighted>Vahab Jabrayilov</span></div><span class=article-date>Sep 8, 2022</span>
<span class=middot-divider></span>
<span class=article-reading-time>4 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/blog/>blog</a></span></div></div><div class=article-container><div class=article-style><h2 id=overview>Overview</h2><p>The main goal was to support on the fly compaction of TSDB blocks without using any disk space or constant amount of the disk space. As analyzing, I came across with the following challenges:</p><ul><li>TSDB blocks have a special structure and the main challenge stems from already big size of a single block.</li><li><code>compactor</code> module is written such that it operates on the already downloaded blocks, so nothing to be done here.</li><li>Initially, I had proposed to have a partial upload and download to accomodate a single download and upload problem, but I identified that downloading dependency (<code>minio</code>) already employs it.</li></ul><h2 id=analysis>Analysis</h2><p>I moved to analyze the whole codebase, and with the help of my supervisor we identified <code>BucketReader</code> interface which is responsible for read access to an object storage bucket and all the other cloud provider support modules are implementing it. My supervisor suggested to imlement a new and scratch version of it which uses a streaming behavior. To be precise, it should bring chunks based on the read index and compact on chunk basis. Howevere, it is not a trivial thing and requires an in depth analysis of TSDB block structure and needs a planning mechanism wo bring which chunks and when to stop bringing. Since, the system is widely used in production, it should be well tested and shouldn;t result in data loss, hence increasing the complexity. So, we decided to take time to in depth analyze the above mentioned problems and come up with a strategy,</p><p><code>BucketReader</code> consists of <code>Iter</code>, <code>Get</code>, <code>GetRange</code>, <code>Exists</code> <code>IsObjNotFoundErr</code> and <code>Attributes</code> functions. In more detail,</p><ul><li><code>Iter</code> calls a given function in the bucket directory passing the entries to the function.</li><li><code>Get</code> provides a reader for the object</li><li><code>GetRange</code> provides a range reader similar to <code>Get</code></li><li><code>Exists</code> checks whether the object exists in the bucket or not</li><li><code>IsObjNotFoundErr</code> returns true if object is not found in the bucket</li><li><code>Attributes</code> gives information about the specified object</li></ul><p>TSDB blocks consists of the head block and following N blocks. Each incoming time-series data point comes to the Head block and stays there, when all of them get old enough they are persisted in the disk as a separate block. WAL and mmap coordinates this process, but only the head and 1&mldr;N blocks are interested in case of compaction, since onlythey are resided in the object storage.</p><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=./tsdb.png alt=tsdb-block loading=lazy data-zoomable></div></div></figure></p><p>Every block has a unique identifier, called a <code>Universally Unique Lexicographically Sortable Identifier(ULID)</code>. A block has 4 constituent parts:</p><ul><li><code>meta.json</code> &ndash;> the medatadata about the block</li><li><code>chunks</code> &ndash;> raw chunks</li><li><code>index</code> &ndash;> index of the block</li><li><code>tombstones</code> &ndash;> marker holding info whether the samples are deleted or not</li></ul><p>Only chunks is directory, other three are regular files.</p><p><code>meta.json</code> has the following structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ulid&#34;</span><span class=o>:</span> <span class=s2>&#34;01EM6Q6A1YPX4G9TEB20J22B2R&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;minTime&#34;</span><span class=o>:</span> <span class=mi>1602237600000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;maxTime&#34;</span><span class=o>:</span> <span class=mi>1602244800000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;stats&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;numSamples&#34;</span><span class=o>:</span> <span class=mi>553673232</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;numSeries&#34;</span><span class=o>:</span> <span class=mi>1346066</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;numChunks&#34;</span><span class=o>:</span> <span class=mi>4440437</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;compaction&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;level&#34;</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sources&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;01EM65SHSX4VARXBBHBF0M0FDS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;01EM6GAJSYWSQQRDY782EA5ZPN&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;version&#34;</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>chunks</code> directory has numbered files each representing a separate chunk and has a size of <code>512 MiB</code>.</p><p>Planning phase of the compaction decides which blocks to compact. In our case, we should read the relevant block metadata and do planning based upon them. Since, metadata files are small in size reading several of them will not incur that much cost. With the new modified planning phase, we can decid upon which blocks are of interest for the current compaction stage and stream the chunks of those blocks in parallel. Reading those streams, one can compact and create new chunks in memory(it may also be mmap-ed file in disk). When the newly created chunks of the block reach some size it can be uploaded to object storage.</p><p>Unfortunately, regarding time constraints and implementation complextiy, the result of above analysis is not completely ready. I plan to incremenetally implement by learning best practices. By analyizng the <code>Thanos</code> code base I get the good grasp of best practices of <code>Go</code> programming language and learned lots of unknown features to me. I believe those will help me to implement the result of analysis.</p><h2 id=acknowledgements>Acknowledgements</h2><p>To sum up, GSoC was a good experience to learn, develop and be a part of larger open source community. Despite the fact that project was challenging, I learned a lot about time series databases, cloud object storage, and <code>Go</code> programming language. I would like to especially thank <code>Ben Ye</code> for his constant support and inspiration, and all <code>Thanos</code> community. Moreover, I would like to express my gratitude to all the folks in <code>Google</code> making the <code>Google Summer of Code</code> and inspiring newbies in the open source.</p></div><div class=article-tags><a class="badge badge-light" href=/tag/gsoc/>gsoc</a>
<a class="badge badge-light" href=/tag/thanos/>thanos</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F&amp;text=GSoC+Final+Submission+Thanos" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F&amp;t=GSoC+Final+Submission+Thanos" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=GSoC%20Final%20Submission%20Thanos&amp;body=https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F&amp;title=GSoC+Final+Submission+Thanos" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=GSoC+Final+Submission+Thanos%20https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fvjabrayilov.github.io%2Fpost%2Fgsoc%2F&amp;title=GSoC+Final+Submission+Thanos" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://vjabrayilov.github.io><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_hu34c6e795ae22d20b097c672b3393d808_113819_270x270_fill_q75_lanczos_center.jpg alt="Vahab Jabrayilov"></a><div class=media-body><h5 class=card-title><a href=https://vjabrayilov.github.io>Vahab Jabrayilov</a></h5><h6 class=card-subtitle>CS PhD Student</h6><p class=card-text>My research interests include operating systems and cloud computing.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:jabrayilov.vahab@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/vjabrayilov7 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?hl=en&amp;user=txBX3mIAAAAJ" target=_blank rel=noopener><i class="fas fa-google-scholar"></i></a></li><li><a href=https://github.com/vjabrayilov target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/vjabrayilov/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2023 Vahab Jabrayilov.</p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.f64289d8217e08e3afcd597d60836062.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.ead4a376bcf2c4714888c770ea9b0040.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>